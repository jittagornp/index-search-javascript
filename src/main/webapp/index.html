<html>
    <head>
        <style>
            .highlighter{
                color : red;
            }

            .level-0 > a{
                font-weight: bold; 
            }
        </style>
    </head>
    <body>
        <script src="jquery.js"></script>
        <script src="repository.js"></script>
        <script src="additionalDictionaries.js"></script>
        <script src="indexsearch.js"></script>
        <script>
            (function($, repository) {
                $(function() {
                    //==========================================================
                    var indexSearch__ = new IndexSearch({
                        repository: repository, //require
                        indexOnFields: ['name'], //require
                        maximumIndexKeySize: 5,
                        additionalDictionaries: additionalDictionaries
                    });
                    //==========================================================

                    var $searchInput = $('#searchInput');
                    var $clearButton = $('#clearButton');
                    var $summary = $('#summary');
                    var $suggestions = $('#suggestions');
                    var $repositories = $('#repositories');

                    showResult(repository);
                    $searchInput.keyup(function() {
                        var keyword = $searchInput.val();
                        var result = indexSearch__.search(keyword);

                        $summary.text('');
                        if (result.getTotalPosition() !== 0) {
                            $summary.text('search : \'' + indexSearch__.getKeyword() + '\' found ' + result.getTotalPosition() + ' positions on ' + result.getTotalSentence() + ' sentences.');
                        }


                        $suggestions.text('');
                        var suggestions = result.getSuggestions();
                        if (suggestions.length !== 0) {
                            $suggestions.append('suggestions : ');
                            for (var suggestIndex in suggestions) {
                                var suggest = suggestions[suggestIndex];
                                var word = suggest.word;

                                if (suggestIndex !== '0') {
                                    $suggestions.append(', ');
                                }

                                if (suggest.percent) {
                                    word = word + '(' + suggest.percent + '%)';
                                }

                                var $suggestItem = $('<a>').attr('href', '#' + suggest.word)
                                        .attr('data-suggest', suggest.word)
                                        .html(word)
                                        .click(function(event) {
                                    event.preventDefault();
                                    $searchInput.val($(this).attr('data-suggest')).keyup();
                                });

                                if (suggest.percent) {
                                    $suggestItem.attr('title', '\'' + suggest.word + '\' same \'' + indexSearch__.getKeyword() + '\' ' + suggest.percent + '%');
                                }
                                
                                $suggestions.append($suggestItem);
                            }

                        }

                        showResult(result.getContent());
                    });

                    $clearButton.click(function() {
                        $searchInput.val('');
                        indexSearch__.clear();
                        $summary.text('');
                        $suggestions.text('');
                        showResult(repository);
                    });

                    function showResult(rootNode) {
                        var $rootDOM = $('<ul>');
                        $repositories.html($rootDOM);
                        walkRepositoryShowResult(rootNode, $rootDOM);
                    }

                    function walkRepositoryShowResult(parentNode, $parentDOM) {
                        var nodes = parentNode.nodes;
                        if (!nodes || nodes.length === 0) {
                            return;
                        }

                        for (var index in nodes) {
                            var childNode = nodes[index];
                            var $link = $('<a>').attr('href', childNode.link).html(childNode.nameHighlight || childNode.name);
                            var $childDOM = $('<ol>');
                            var $list = $('<li>').attr('class', childNode.level).append($link).append($childDOM);
                            $parentDOM.append($list);

                            walkRepositoryShowResult(childNode, $childDOM);
                        }
                    }
                });
            })(jQuery, node);
        </script>

        <input id="searchInput"/><button id="clearButton">clear</button>
        <div id="result">
            <div id="summary"></div>
            <div id="suggestions"></div>
            <div id="repositories"></div>
        </div>
    </body>
</html>