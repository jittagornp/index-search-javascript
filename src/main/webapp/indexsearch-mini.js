/**
 * IndexSearch.js
 *
 * author     -->  redcrow (jittagorn pitakmetagoon)
 * create on  -->  26/08/2013
 * website    -->  na5cent.blogspot.com
 * 
 * version    -->  1.0
 * version    -->  2.0 (multiple search keyword : AND search operation)
 * 
 * License    ---> Apache License
 * Version 2.0, January 2004 (http://www.apache.org/licenses/LICENSE-2.0)
 * 
 * 
 * 
 * update 13/12/2013 : add integrate period algorithm (document : http://na5cent.blogspot.com/2013/12/integrate-period-algorithm-javascript.html)
 */

window.IndexSearch=window.IndexSearch||function(){function m(a){return l(a)||0===a.length}function x(a,b,c){if(l(a))return-1;k(b,"String")&&(a=a.toLowerCase(),b=b.toLowerCase());return b.indexOf(a,l(c)?0:c)}function y(a){return a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}function f(a,b,c){if(!l(a)&&k(b,"Function"))for(var d in a)if(!1===b.call(c,a[d],d))return!1;return!0}function k(a,b){return Object.prototype.toString.call(a)==="[object "+b+"]"}function l(a){return k(a,
"Undefined")}function q(a){var b=0,c;for(c in a)b+=1;return b}function t(a){var b=parseFloat(a),c=parseInt(a);return 0===b-c?c:(new Number(a)).toFixed(2)}var D=function(){function a(a,b){if(!k(a,"String"))throw Error("constructor of Interface class require first argument is 'string', but is '"+typeof a+"'.");if(!k(b,"Array"))throw Error("constructor of Interface class require second argument is 'array of string', but is '"+typeof b+"'.");}function b(a,b){if(!k(a,"String"))throw Error("constructor of Interface class require second argument is 'array of string', but method index "+
b+" is not 'string', is '"+typeof a+"'.");return a}return function(c,d){if(2!==arguments.length)throw Error("constructor of Interface class require 2 arguments : Interface({string} name, {string[]} method names");a(c,d);for(var h=[],n=0;n<d.length;n++){var e=b(d[n],n);h.push(e)}this.getName=function(){return c};this.getMethods=function(){return h}}}();D.ensureImplements=function(a,b){if(2!==arguments.length)throw Error("Interface.ensureImplements require 2 arguments : Interface.ensureImplement({object} obj, {interface[]} interfaces).");
if(!k(a,"Object"))throw Error("first argument of Interface.ensureImplements is not 'object', but is '"+typeof a+"'.");if(!k(b,"Array"))throw Error("second argument of Interface.ensureImplements is not 'array of interface', but is '"+typeof b+"'.");for(var c=0;c<b.length;c++){var d=b[c];if(d.constructor!==D)throw Error("second argument of Interface.ensureImplements index "+c+" is not interface.");var h=d.getMethods(),n;for(n in h){var e=h[n];if(l(a[e]))throw Error("implementation class is not define method '"+
e+"' of Interface '"+d.getName()+"'.");if(!k(a[e],"Function"))throw Error("implementation class define '"+e+"' is not 'method', but is '"+typeof a[e]+"'.");}}};var E=function(a){var b=a.totalPosition||0,c=a.totalSentence||0,d=a.content||{nodes:{}},h=a.suggestions||[];this.getTotalPosition=function(){return b};this.getTotalSentence=function(){return c};this.getContent=function(){return d};this.getSuggestions=function(){return h}},A=function(a,b){var c=a,d=b;this.getStart=function(){return c};this.getEnd=
function(){return d};this.setStart=function(a){c=a};this.setEnd=function(a){d=a};this.equals=function(a){return a.getStart()===c&&a.getEnd()===d?!0:!1};this.toString=function(){return"period {"+c+", "+d+"}"}},C=function(){function a(){var a=[];f(d,function(e){a.push(e)});return a}function b(){h=a().sort(function(a,e){return a.getStart()===e.getStart()?a.getEnd()-e.getEnd():a.getStart()-e.getStart()})}function c(a){for(var e in h)h[e].equals(a)&&delete h[e]}var d={},h;this.addPeriod=function(a){var e;
e=a.getStart()+":"+a.getEnd();l(d[e])&&(d[e]=a);return this};this.addAllPeriods=function(a){m(a)||f(a,function(a){this.addPeriod(a)},this);return this};this.integrate=function(){b();if(1<h.length)for(var a=1;a<h.length;a++){var e=h[a-1],g=h[a];g.getStart()<e.getEnd()&&g.setStart(e.getEnd())}if(1<h.length)for(a=1;a<h.length;a++)for(e=h[a],g=a+1;g<h.length;g++){var B=h[g],p;if(p=!l(e))if(p=!l(B))if(p=B,!(p=p.getStart()>=p.getEnd())){p=B;var d=e;p=p.getStart()>=d.getStart()&&p.getEnd()<=d.getEnd()}p&&
c(B)}if(1<h.length)for(a=1;a<h.length;a++)e=h[a-1],g=h[a],l(g)||l(e)||g.getStart()!==e.getEnd()||(g.setStart(e.getStart()),c(e),a--);return h}},u=function(a){var b=a||"",c=0;this.split=function(){var a=[],h=b.split(" ");f(h,function(b){m(b)||(a.push(b),c+=1)});return a};this.getKeywordSize=function(){return c}},v=function(a){function b(a,b){var e=new C,g=new u(b);f(g.split(),function(g){if(m(g))return!0;for(var b=g.length,c=0,d=0;;){d=x(g,a,d);if(-1===d)break;c=d;d+=b;e.addPeriod(new A(c,d))}});return e.integrate()}
var c=0,d=0;this.getTotalSentence=function(){return c};this.resetTotalSentence=function(){c=0};this.getTotalHighlight=function(){return d};this.resetTotalHighlight=function(){d=0};this.resetTotal=function(){c=d=0};this.highlight=function(h,l){c+=1;var e=y(l),g=b(e,h),B=0;f(g,function(g){var b=g.getStart()+B,c=g.getEnd()+B;g=e.substring(0,b);var b=e.substring(b,c),h='<span class="'+a+'">'+b+"</span>",c=e.substring(c);e=g+h+c;B=B+h.length-b.length;d+=1});return e}},G=new D("IndexStore",["writeIndex",
"readIndex","addDictionary","getDictionaries","getIndexs"]),H=function(a){function b(a,g){var b=c(a);return d(b,g)}function c(a){var g={};f(a,function(a){f(a,function(a){l(g[a])&&(g[a]=0);g[a]+=1})});return g}function d(a,g){var b=[];f(a,function(a,e){a>=g&&b.push(e)});return b}var h=a;if(l(h)||1>h)h=1;var n=[];for(a=1;a<=h;a++)n[a]={};this.writeIndex=function(a,g){l(g)||f(n,function(b){f(b,function(b){f(b,function(b,c){-1!==x(c,g)&&-1===x(a,b)&&b.push(a)})})})};this.readIndex=function(a){var g={};
a=new u(a);f(a.split(),function(a){f(this.getDictionaries(a),function(b,e){-1!==x(a,e)&&(l(g[a])&&(g[a]={}),f(b,function(b){g[a][b]=b}))})},this);return b(g,a.getKeywordSize())};this.addDictionary=function(a){a=a.trim().toLowerCase();m(a)||f(n,function(b,c){if(a.length>=c){var d=a.substring(0,c);l(b[d])&&(b[d]={});l(b[d][a])&&(b[d][a]=[])}})};this.getDictionaries=function(a){if(m(a))return{};a=new u(a);var b={};f(a.split(),function(a){var c=b;a.length<=h?a=n[a.length][a]:(a=a.substring(0,h),a=n[h][a]);
for(var d in a)c[d]=a[d]});l(b)&&(b={});return b};this.getIndexs=function(){return n}},I=function(a){this.writeIndex=function(b,c){a.writeIndex(b,c)};this.addDictionary=function(b){a.addDictionary(b)}},J=function(a){this.readIndex=function(b){return a.readIndex(b)};this.getDictionaries=function(b){return a.getDictionaries(b)};this.getIndexs=function(){return a.getIndexs()}},L=function(a){function b(a){for(var b={},c=0;c<a.length;c++){var d=a.charAt(c);l(b[d])&&(b[d]={duplicate:0,position:0});b[d].duplicate+=
1;b[d].position+=c}return b}function c(a,c){var p=[],n=(new u(a)).split();f(n,function(u){return f(d,function(d,f){var k;a:{for(k in n)if(n[k]===f){k=!0;break a}k=!1}if(k=!k){var s;a:{k=p;for(s in k)if(k[s].word===f){s=!0;break a}s=!1}k=!s}if(k){k=b(u);var r,v=b(f);s=0;for(r in k){l(v[r])&&(v[r]={duplicate:0,position:0});var z=k[r],w=v[r],z=z.duplicate+z.position,w=w.duplicate+w.position;if(0!==z&&0!==w){var x=(w+z)/2;s=z>=w?s+w/x:s+z/x}}r=(q(k)+q(v))/2;r=s/r*100;if(r>=c&&(s=h.highlight(a,f),m(s)&&
(s=f),p.push({keywordMatch:u,word:f,highlight:s,percent:t(r)}),p.length===e))return!1}})});return p=p.sort(function(a,b){return b.percent-a.percent})}var d=a.dictionary,h=a.highlighter,n=a.percentSuggest||60,e=a.suggestionsSize||10;this.getSuggestionsWhenSearchFound=function(a){return c(a,0)};this.getSuggestionsWhenSearchNotFound=function(a){return c(a,n)}};return function(a){function b(){for(var a in z)t.addDictionary(z[a]);c(g);for(var b in g.nodes)d(0,b,g.nodes[b]);for(var e in F)delete F[e]}function c(a){for(var b in u){var d=
a[u[b]];if(!m(d)){var d=M(d),e=void 0;for(e in d)t.addDictionary(d[e])}}a=a.nodes;if(!m(a))for(var g in a)c(a[g])}function d(a,b,c){h(c,function(a){t.writeIndex(b,a)});c.level="level-"+a;c.index=b+"";c=c.nodes;if(!m(c))for(var e in c)d(a+1,b+A+e,c[e])}function h(a,b){for(var c in u){var d=u[c],e=F[d];l(e)&&(e={},F[d]=e);var g=e[a[d]];l(g)&&(g=!0,e[a[d]]=g,b(a[d]))}}function f(){return new E({totalPosition:p.getTotalHighlight(),totalSentence:p.getTotalSentence(),content:s,suggestions:w})}function e(){var a=
y.readIndex(r),b;for(b in a){var c=a[b].split(A),d=g,e=s,h=void 0;for(h in c){var k=c[h];if(m(k))break;var d=d.nodes[k],f=e.nodes[k];if(l(f)){var f=d,n={},v=void 0;for(v in f)if("nodes"!==v){n[v]=f[v];for(var q in u)if(v===u[q]){var t=p.highlight(r,n[v]);m(t)||(n[v+C]=t)}}f=n;e.nodes[k]=f}l(f.nodes)&&(f.nodes=[]);e=f}}}if(l(a))throw Error("require {object} settings");var g=a.repository;if(l(g))throw Error("require {repository} settings.repository");if(!k(g,"Object"))throw Error("require {repository} settings.repository is root node object");
var u=a.indexOnFields||[];if(m(u))throw Error("require index field on {string[]} : settings.indexOnFields");if(-1!==x("nodes",u))throw Error("field name 'nodes' in {string[]} : settings.indexOnFields is reserved word");var p=new v(a.highlightClass||"keyword-highlight"),q=a.indexStore||new H(a.maximumDictionaryKeySize||3);D.ensureImplements(q,[G]);var t=new I(q),y=new J(q),A=a.indexSeparator||"/",C=a.postfixFieldNameHighlight||"Highlight",s,r="",F={},z=a.additionalDictionaries||[],w=[],K=a.suggestionsSize,
N=a.percentSuggest,M=a.stopword||function(a){a=l(a)?"":a.replace(/\(/g," ").replace(/\)/g," ").replace(/\,/g," ").replace(/\//g," ").replace(/\\/g," ").replace(/\:/g," ").replace(/\./g," ").replace(/\>/g," ").replace(/\</g," ").replace(/\[/g," ").replace(/\]/g," ").replace(/\+/g," ").replace(/\=/g," ").replace(/\;/g," ");return a.split(" ")};b();this.reIndex=function(a){g=a;b()};this.getKeyword=function(){return r};this.getRepository=function(){return g};this.getIndexs=function(){return y.getIndexs()};
this.clear=function(){r="";return new E({content:g})};this.search=function(a){if(m(a))return new E({content:g});a=a.trim().toLowerCase();if(r===a)return f();p.resetTotal();s={nodes:[]};w=[];r=a;e();w=(new L({dictionary:y.getDictionaries(r),suggestionsSize:K,percentSuggest:N,highlighter:p})).getSuggestionsWhenSearchFound(r);m(s.nodes)&&!m(w)&&(r=w[0].word,e());return f()}}}();window.Blogger=window.Blogger||{};
window.Blogger.pullRepositoryFromBlog=function(m,x){var y=document.createElement("script");y.type="text/javascript";y.src=m+"/feeds/posts/default?max-results=10000&alt=json-in-script&callback=blogFeedCallback";y.onload=function(){x(window.blogFeedRepository)};document.getElementsByTagName("head")[0].appendChild(y)};
function blogFeedCallback(m){function x(f){f=f.sort(function(f,k){return f.published>k.published})}function y(f){var l=k.nodes,m;for(m in l){var q=l[m];if(q.name===f)return q}return null}function f(f){f=f.link;for(var k in f)if("alternate"===f[k].rel)return f[k].href;return""}var k={nodes:[]},l=m.feed,q=l.category,t;for(t in q)m=q[t],k.nodes.push({name:m.term,link:"/search/label/"+encodeURIComponent(m.term)});l=l.entry;for(t in l){q=l[t];q.title.$t;var D=q.category,E;for(E in D){m=y(D[E].term);var A=
m.nodes;A||(A=[]);var C={name:q.title.$t,published:new Date(q.published.$t),link:f(q),nodes:[]};5>t&&(C.newPost=!0);A.push(C);m.nodes=A}}(function(f){f=f.sort(function(f,k){return f.name.localeCompare(k.name)})})(k.nodes);for(t in k.nodes)C=k.nodes[t],x(C.nodes);window.blogFeedRepository=k};

