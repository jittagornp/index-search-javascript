/**
 * class IndexSearch
 * @author redcrow (jittagorn pitakmetagoon)
 * @create on 26/08/2013
 * @website na5cent.blogspot.com
 * @version 1.0
 * 
 * License
 * Apache License
 * Version 2.0, January 2004
 * http://www.apache.org/licenses/
 * 
 * can see on https://github.com/jittagornp/index-search-javascript/blob/master/LICENSE
 */

var IndexSearch=function(){function r(a){return g(a)||0===a.length}function m(a,b){p(b,"String")&&(a=a.toLowerCase(),b=b.toLowerCase());return b.indexOf(a)}function w(a){return a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}function p(a,b){return Object.prototype.toString.call(a)==="[object "+b+"]"}function g(a){return p(a,"Undefined")}function y(a){var b=0,c;for(c in a)b+=1;return b}function C(a){var b=parseFloat(a),c=parseInt(a);return 0===b-c?c:(new Number(a)).toFixed(2)}
var v=function(){function a(a,b){if(!p(a,"String"))throw Error("constructor of Interface class require first argument is 'string', but is '"+typeof a+"'.");if(!p(b,"Array"))throw Error("constructor of Interface class require second argument is 'array of string', but is '"+typeof b+"'.");}function b(a,b){if(!p(a,"String"))throw Error("constructor of Interface class require second argument is 'array of string', but method index "+b+" is not 'string', is '"+typeof a+"'.");return a}return function(c,
k){if(2!==arguments.length)throw Error("constructor of Interface class require 2 arguments : Interface({string} name, {string[]} method names");a(c,k);for(var h=[],d=0;d<k.length;d++){var e=b(k[d],d);h.push(e)}this.getName=function(){return c};this.getMethods=function(){return h}}}();v.ensureImplements=function(a,b){if(2!==arguments.length)throw Error("Interface.ensureImplements require 2 arguments : Interface.ensureImplement({object} obj, {interface[]} interfaces).");if(!p(a,"Object"))throw Error("first argument of Interface.ensureImplements is not 'object', but is '"+
typeof a+"'.");if(!p(b,"Array"))throw Error("second argument of Interface.ensureImplements is not 'array of interface', but is '"+typeof b+"'.");for(var c=0;c<b.length;c++){var k=b[c];if(k.constructor!==v)throw Error("second argument of Interface.ensureImplements index "+c+" is not interface.");var h=k.getMethods(),d;for(d in h){var e=h[d];if(g(a[e]))throw Error("implementation class is not define method '"+e+"' of Interface '"+k.getName()+"'.");if(!p(a[e],"Function"))throw Error("implementation class define '"+
e+"' is not 'method', but is '"+typeof a[e]+"'.");}}};var z=function(a){var b=a.totalPosition||0,c=a.totalSentence||0,k=a.content||{nodes:{}},h=a.suggestions||[];this.getTotalPosition=function(){return b};this.getTotalSentence=function(){return c};this.getContent=function(){return k};this.getSuggestions=function(){return h}},H=function(a){var b=0,c=0;this.getTotalSentence=function(){return b};this.resetTotalSentence=function(){b=0};this.getTotalHighlight=function(){return c};this.resetTotalHighlight=
function(){c=0};this.resetTotal=function(){b=c=0};this.highlight=function(k,h){var d="",e=k.length,f=m(k,h);if(-1===f)return d;for(b+=1;;){c+=1;var g=f+e,q=w(h.substring(0,f)),f=h.substring(f,g),f="<span class="+a+">"+w(f)+"</span>",d=d+q+f;h=h.substring(g);f=m(k,h);if(-1===f){d+=w(h);break}}return d}},I=new v("IndexStore",["writeIndex","readIndex","addDictionary","getDictionary","getIndexs"]),J=function(a){var b=a;if(g(b)||1>b)b=1;var c=[];for(a=1;a<=b;a++)c[a]={};this.writeIndex=function(a,b){if(!g(b))for(var d in c)for(var e in c[d]){var f=
c[d][e],t;for(t in f){var q=f[t];-1!==m(t,b)&&-1===m(a,q)&&q.push(a)}}};this.readIndex=function(a){var b=this.getDictionary(a),c=[],e;for(e in b)if(-1!==m(a,e)){var f=b[e],g;for(g in f)-1!==m(f[g],c)||c.push(f[g])}return c};this.addDictionary=function(a){a=a.trim().toLowerCase();if(!r(a))for(var b in c)if(a.length>=b){var d=a.substring(0,b),e=c[b][d];g(e)&&(c[b][d]={},e=c[b][d]);g(e[a])&&(e[a]=[])}};this.getDictionary=function(a){if(r(a))return{};var h={},h=a.length<=b?c[a.length][a]:c[b][a.substring(0,
b)];g(h)&&(h={});return h};this.getIndexs=function(){return c}},K=function(a){this.writeIndex=function(b,c){a.writeIndex(b,c)};this.addDictionary=function(b){a.addDictionary(b)}},L=function(a){this.readIndex=function(b){return a.readIndex(b)};this.getDictionary=function(b){return a.getDictionary(b)};this.getIndexs=function(){return a.getIndexs()}},E=function(a){function b(a){for(var b={},c=0;c<a.length;c++){var d=a.charAt(c);g(b[d])&&(b[d]={duplicate:0,position:0});b[d].duplicate+=1;b[d].position+=
c}return b}function c(a,b){var c=0,d;for(d in a){g(b[d])&&(b[d]={duplicate:0,position:0});var e=a[d],l=b[d],e=e.duplicate+e.position,l=l.duplicate+l.position;if(0!==e&&0!==l)var f=(l+e)/2,c=e>=l?c+l/f:c+e/f}d=(y(a)+y(b))/2;return 100*(c/d)}function k(a,e){var g=[],k;for(k in d){var s=k;if(a!==k){var l=b(a),n=b(s),l=c(l,n);if(l>=e&&(n=h(a,s),r(n)&&(n=s),g.push({word:s,highlight:n,percent:C(l)}),g.length===f))break}}return g=g.sort(function(a,b){return b.percent-a.percent})}function h(a,b){for(var c=
"",d=0;d<b.length;d++){for(var e=b.charAt(d),f=!1,g=0;g<a.length;g++)if(a.charAt(g)===e){f=!0;break}c=f?c+"<span class="+p+">"+e+"</span>":c+e}return c}var d=a.dictionary,e=a.percentSuggest||60,f=a.suggestionsSize||10,p=a.highlightClass||"keyword-highlight";this.getSuggestionsWhenSearchFound=function(a){return k(a,0)};this.getSuggestionsWhenSearchNotFound=function(a){return k(a,e)}};return function(a){function b(){c(d);for(var a in D)q.addDictionary(D[a]);for(var b in d.nodes)k(0,b,d.nodes[b]);for(var e in n)delete n[e]}
function c(a){for(var b in e){var d=a[e[b]];if(!r(d)){var d=C(d),g=void 0;for(g in d)q.addDictionary(d[g])}}a=a.nodes;if(!r(a))for(var f in a)c(a[f])}function k(a,b,d){h(d,function(a){q.writeIndex(b,a)});d.level="level-"+a;d.index=b+"";d=d.nodes;if(!r(d))for(var c in d)k(a+1,b+w+c,d[c])}function h(a,b){for(var d in e){var c=e[d],f=n[c];g(f)&&(f={},n[c]=f);var h=f[a[c]];g(h)&&(h=!0,f[a[c]]=h,b(a[c]))}}if(g(a))throw Error("require {object} settings");var d=a.repository;if(g(d))throw Error("require {repository} settings.repository");
if(!p(d,"Object"))throw Error("require {repository} settings.repository is root node object");var e=a.indexOnFields||[];if(r(e))throw Error("require index field on {string[]} : settings.indexOnFields");if(-1!==m("nodes",e))throw Error("field name 'nodes' in {string[]} : settings.indexOnFields is reserved word");var f=new H(a.highlightClass||"keyword-highlight"),t=a.indexStore||new J(a.maximumDictionaryKeySize||3);v.ensureImplements(t,[I]);var q=new K(t),A=new L(t),w=a.indexSeparator||"/",y=a.postfixFieldNameHighlight||
"Highlight",s,l="",n={},D=a.additionalDictionaries||[],x=[],B=0,F=a.suggestionsSize,G=a.percentSuggest,C=a.stopword||function(a){a=g(a)?"":a.replace(/\(/g," ").replace(/\)/g," ").replace(/\,/g," ").replace(/\//g," ").replace(/\\/g," ").replace(/\:/g," ").replace(/\./g," ").replace(/\>/g," ").replace(/\</g," ").replace(/\[/g," ").replace(/\]/g," ").replace(/\+/g," ").replace(/\=/g," ").replace(/\;/g," ");return a.split(" ")};b();this.reIndex=function(a){d=a;b()};this.getKeyword=function(){return l};
this.getRepository=function(){return d};this.getIndexs=function(){return A.getIndexs()};this.clear=function(){l="";return new z({content:d})};this.search=function(a){if(r(a))return new z({content:d});a=a.trim().toLowerCase();if(l===a)return new z({totalPosition:f.getTotalHighlight(),totalSentence:f.getTotalSentence(),content:s,suggestions:x});f.resetTotal();s={nodes:[]};x=[];l=a;a=A.readIndex(l);for(var b in a){var c=a[b].split(w),h=d,k=s,p=void 0;for(p in c){var n=c[p];if(r(n))break;var h=h.nodes[n],
u=k.nodes[n];if(g(u)){var u=h,q={},m=void 0;for(m in u)if("nodes"!==m){q[m]=u[m];for(var t in e)if(m===e[t]){var v=f.highlight(l,q[m]);r(v)||(q[m+y]=v)}}u=q;k.nodes[n]=u}g(u.nodes)&&(u.nodes=[]);k=u}}r(s.nodes)?(B+=1,b=l.substring(0,l.length-B),x=(new E({dictionary:A.getDictionary(b),suggestionsSize:F,percentSuggest:G})).getSuggestionsWhenSearchNotFound(l)):(B=0,x=(new E({dictionary:A.getDictionary(l),suggestionsSize:F,percentSuggest:G})).getSuggestionsWhenSearchFound(l));return new z({totalPosition:f.getTotalHighlight(),
totalSentence:f.getTotalSentence(),content:s,suggestions:x})}}}();